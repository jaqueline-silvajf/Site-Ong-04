// ============================================================
// Organiza√ß√£o Solid√°ria - main.js
// Atividade 3: JavaScript avan√ßado (DOM, valida√ß√£o, armazenamento, SPA)
// ============================================================

// ---------- Fun√ß√µes Utilit√°rias ----------
function apenasNumeros(str){return str.replace(/\D/g,"")}function formatCPF(valor){valor=apenasNumeros(valor).slice(0,11);valor=valor.replace(/(\d{3})(\d)/,"$1.$2");valor=valor.replace(/(\d{3})(\d)/,"$1.$2");return valor.replace(/(\d{3})(\d{1,2})$/,"$1-$2")}function formatTelefone(valor){valor=apenasNumeros(valor).slice(0,11);return valor.length<=10?valor.replace(/(\d{2})(\d{4})(\d{0,4})/,"($1) $2-$3").replace(/-$/,""):valor.replace(/(\d{2})(\d{5})(\d{0,4})/,"($1) $2-$3").replace(/-$/,"")}function formatCEP(valor){valor=apenasNumeros(valor).slice(0,8);return valor.replace(/(\d{5})(\d{0,3})/,"$1-$2").replace(/-$/,"")}

// ---------- M√°scaras autom√°ticas ----------
function aplicarMascaras(){const cpf=document.getElementById("cpf");const tel=document.getElementById("telefone");const cep=document.getElementById("cep");if(cpf)cpf.addEventListener("input",(e)=>e.target.value=formatCPF(e.target.value));if(tel)tel.addEventListener("input",(e)=>e.target.value=formatTelefone(e.target.value));if(cep)cep.addEventListener("input",(e)=>e.target.value=formatCEP(e.target.value))}

// ---------- Valida√ß√µes ----------
function validarCPF(cpf){cpf=apenasNumeros(cpf);if(cpf.length!==11||/^(\d)\1+$/.test(cpf))return false;let soma=0;for(let i=0;i<9;i++)soma+=parseInt(cpf[i])*(10-i);let resto=(soma*10)%11;if(resto===10)resto=0;if(resto!==parseInt(cpf[9]))return false;soma=0;for(let i=0;i<10;i++)soma+=parseInt(cpf[i])*(11-i);resto=(soma*10)%11;if(resto===10)resto=0;return resto===parseInt(cpf[10])}function validarCampos(dados){const erros=[];if(!dados.nome||dados.nome.length<3)erros.push("Nome inv√°lido (m√≠nimo 3 letras)");if(!dados.email.includes("@"))erros.push("E-mail inv√°lido");if(!validarCPF(dados.cpf))erros.push("CPF inv√°lido");if(!/^\(\d{2}\)\s?\d{4,5}-\d{4}$/.test(dados.telefone))erros.push("Telefone inv√°lido");if(!dados.nascimento)erros.push("Informe a data de nascimento");if(!/^\d{5}-\d{3}$/.test(dados.cep))erros.push("CEP inv√°lido");return erros}

// ---------- Armazenamento Local ----------
function salvarVoluntario(dados){const lista=JSON.parse(localStorage.getItem("voluntarios")||"[]");lista.push(dados);localStorage.setItem("voluntarios",JSON.stringify(lista))}function listarVoluntarios(){return JSON.parse(localStorage.getItem("voluntarios")||"[]")}

// ---------- Exibi√ß√£o din√¢mica de volunt√°rios ----------
function renderizarVoluntarios(){const lista=listarVoluntarios();const container=document.createElement("section");container.innerHTML="<h2>Volunt√°rios Cadastrados</h2>";if(lista.length===0){container.innerHTML+="<p>Nenhum volunt√°rio cadastrado ainda.</p>"}else{const ul=document.createElement("ul");lista.forEach((v)=>{const li=document.createElement("li");li.textContent=`${v.nome} ‚Äî ${v.email} ‚Äî ${v.telefone} ‚Äî ${v.cidade}/${v.estado}`;ul.appendChild(li)});container.appendChild(ul)}const main=document.querySelector("main");if(main)main.appendChild(container)}

// ---------- SPA b√°sica (navega√ß√£o sem recarregar) ----------
function inicializarSPA(){document.querySelectorAll("nav a").forEach((link)=>{link.addEventListener("click",(e)=>{const destino=link.getAttribute("href");if(destino.endsWith(".html")){e.preventDefault();carregarPagina(destino)}})})}async function carregarPagina(url){try{const resposta=await fetch(url);const texto=await resposta.text();const novoDoc=new DOMParser().parseFromString(texto,"text/html");const novoMain=novoDoc.querySelector("main");const main=document.querySelector("main");if(novoMain&&main){main.innerHTML=novoMain.innerHTML;aplicarMascaras();configurarFormulario()}history.pushState({},"",url)}catch(erro){console.error("Erro ao carregar p√°gina:",erro)}}

// ---------- Configura√ß√£o do formul√°rio ----------
function configurarFormulario(){const form=document.getElementById("form-cadastro");if(!form)return;form.addEventListener("submit",(e)=>{e.preventDefault();const dados={nome:form.nome.value.trim(),email:form.email.value.trim(),cpf:form.cpf.value.trim(),telefone:form.telefone.value.trim(),nascimento:form.nascimento.value,endereco:form.endereco.value.trim(),cep:form.cep.value.trim(),cidade:form.cidade.value.trim(),estado:form.estado.value,area:form.area.value,turno:Array.from(form.querySelectorAll("input[name='turno']:checked")).map(i=>i.value)};const erros=validarCampos(dados);if(erros.length>0){alert("Corrija os seguintes erros:\n- "+erros.join("\n- "));return}salvarVoluntario(dados);alert("Cadastro realizado com sucesso!");form.reset();renderizarVoluntarios()})}

// ---------- Inicializa√ß√£o ----------
document.addEventListener("DOMContentLoaded",()=>{aplicarMascaras();configurarFormulario();inicializarSPA();const anoSpan=document.getElementById("ano")||document.getElementById("ano2")||document.getElementById("ano3");if(anoSpan)anoSpan.textContent=new Date().getFullYear();renderizarVoluntarios()});


// ---------- Modo Escuro / Alto Contraste ----------
function toggleDarkMode(){
  document.body.classList.toggle("modo-escuro");
  const ativo=document.body.classList.contains("modo-escuro");
  localStorage.setItem("modoEscuro",ativo);
  document.getElementById("toggle-tema").textContent=ativo?"‚òÄÔ∏è Modo Claro":"üåô Modo Escuro";
}
function aplicarPreferencia(){
  const ativo=localStorage.getItem("modoEscuro")==="true";
  if(ativo)document.body.classList.add("modo-escuro");
}
document.addEventListener("DOMContentLoaded",()=>{
  aplicarPreferencia();
  const btn=document.getElementById("toggle-tema");
  if(btn){
    btn.addEventListener("click",toggleDarkMode);
    const ativo=document.body.classList.contains("modo-escuro");
    btn.textContent=ativo?"‚òÄÔ∏è Modo Claro":"üåô Modo Escuro";
  }
});
